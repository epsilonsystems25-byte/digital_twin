<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>3-Phase Motor - Industrial Lab Simulator</title>

    <style>

        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; }

        canvas { display: block; }

        

        #ui-panel { position: absolute; top: 20px; left: 20px; z-index: 100; pointer-events: none; }

        h1 { color: #00f2ff; margin: 0; font-size: 24px; text-shadow: 0 0 10px #00f2ff; }

        p { color: #aaa; margin: 5px 0 10px 0; font-size: 12px; letter-spacing: 1px; }

        

        .controls-hint { color: #555; font-size: 10px; margin-bottom: 15px; }



        .btn-group { display: flex; gap: 10px; pointer-events: auto; }

        .toggle-btn {

            pointer-events: auto; padding: 12px 25px; background: rgba(0, 242, 255, 0.1);

            border: 2px solid #00f2ff; color: #00f2ff; font-weight: bold;

            text-transform: uppercase; cursor: pointer; border-radius: 5px;

            transition: all 0.3s ease; box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);

        }

        .toggle-btn:hover { background: #00f2ff; color: #000; box-shadow: 0 0 25px #00f2ff; }

        .active-btn { background: #00f2ff; color: #000; }



        #neon-tooltip {

            position: fixed; display: none; pointer-events: none;

            background: rgba(0, 20, 30, 0.85); border: 1px solid #00f2ff;

            color: #00f2ff; padding: 8px 15px; font-family: 'Courier New', monospace;

            font-size: 14px; font-weight: bold; text-transform: uppercase;

            box-shadow: 0 0 15px rgba(0, 242, 255, 0.5); z-index: 1000;

            clip-path: polygon(0% 0%, 90% 0%, 100% 30%, 100% 100%, 10% 100%, 0% 70%);

        }

        #info-popup {

            display: none; position: fixed; z-index: 1001; min-width: 220px;

            background: #1a2b4b; border: 1px solid #00f2ff;

            border-radius: 6px; box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);

            font-family: 'Segoe UI', sans-serif; overflow: hidden;

        }

        #info-popup.visible { display: block; }

        #info-popup .popup-header {

            background: #00f2ff; color: #0a1628; padding: 10px 36px 10px 14px;

            font-weight: 700; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;

            position: relative;

        }

        #info-popup .popup-close {

            position: absolute; top: 8px; right: 10px; width: 20px; height: 20px;

            background: #ef4444; color: #fff; border: none; border-radius: 4px;

            cursor: pointer; font-size: 14px; line-height: 1; padding: 0;

        }

        #info-popup .popup-close:hover { background: #dc2626; }

        #info-popup .popup-body { padding: 12px 14px; }

        #info-popup .popup-row { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 8px; font-size: 13px; }

        #info-popup .popup-row:last-child { margin-bottom: 0; }

        #info-popup .popup-label { color: #94a3b8; }

        #info-popup .popup-value { font-weight: 600; }

    </style>

</head>

<body>



    <div id="ui-panel">

        <h1>3-PHASE MOTOR LAB</h1>

        <p>ENVIRONMENT: VIRTUAL WORKSTATION</p>

        <div class="controls-hint">WALK: W,A,S,D | ROTATE: MOUSE LEFT | ZOOM: SCROLL</div>

        <div class="btn-group">

            <button class="toggle-btn" onclick="toggleView()">Blueprint</button>

            <button id="explodeBtn" class="toggle-btn" onclick="toggleExplode()">Explode View</button>

        </div>

    </div>



    <div id="neon-tooltip"></div>

    <div id="info-popup">
        <div class="popup-header"><span id="popup-title">Component</span><button class="popup-close" onclick="closeInfoPopup()" aria-label="Close">&times;</button></div>
        <div class="popup-body">
            <div class="popup-row"><span class="popup-label">Frequency</span><span class="popup-value" id="popup-freq">--</span></div>
            <div class="popup-row"><span class="popup-label">Body Temp</span><span class="popup-value" id="popup-temp">--</span></div>
            <div class="popup-row"><span class="popup-label">Current</span><span class="popup-value" id="popup-current">--</span></div>
            <div class="popup-row"><span class="popup-label">Vibration</span><span class="popup-value" id="popup-vib">--</span></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>



    <script>

        let scene, camera, renderer, controls, motorGroup;

        let isBlueprint = false, isExploded = false;

        let materialsMap = new Map(), originalPositions = new Map();

        const raycaster = new THREE.Raycaster(), mouse = new THREE.Vector2();

        const tooltip = document.getElementById('neon-tooltip');

        let hoveredMesh = null;

        /* Shared with dashboard via postMessage from React useMotorData */
        let motorDisplayData = { frequency: null, tempAvg: null, currentAvg: null, vibration: null };

        window.addEventListener('message', function(e) {
            if (e.data && e.data.type === 'MOTOR_DATA' && e.data.motorData) {
                var m = e.data.motorData;
                var t1 = m.temperature && m.temperature.t1 != null ? m.temperature.t1 : 0;
                var t2 = m.temperature && m.temperature.t2 != null ? m.temperature.t2 : 0;
                var pa = m.current && m.current.phaseA != null ? m.current.phaseA : 0;
                var pb = m.current && m.current.phaseB != null ? m.current.phaseB : 0;
                var pc = m.current && m.current.phaseC != null ? m.current.phaseC : 0;
                motorDisplayData = {
                    frequency: m.frequency != null ? m.frequency : 50,
                    tempAvg: (t1 + t2) / 2,
                    currentAvg: (pa + pb + pc) / 3,
                    vibration: e.data.latestVibration != null ? e.data.latestVibration : 0
                };
            }
        });

        const partIdToTitle = { frame: 'Stator Frame', rib: 'Cooling Rib', coil_r: 'Copper Winding A', coil_l: 'Copper Winding B',

            rotor: 'Rotor', shaft: 'Drive Shaft', brg_r: 'Ball Bearing Front', brg_l: 'Ball Bearing Rear',

            bell_r: 'End Shield A', bell_l: 'End Shield B', fan: 'Fan Blade', cover: 'Fan Cover', box: 'Terminal Box', eye: 'Eye Bolt', base: 'Mounting Base' };

        const keys = { w: false, a: false, s: false, d: false };

        init();

        createEnvironment();

        createMotor();

        animate();



        function init() {

            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);

            camera.position.set(0, 15, 30);



            renderer = new THREE.WebGLRenderer({ antialias: true });

            renderer.setSize(window.innerWidth, window.innerHeight);

            renderer.shadowMap.enabled = true;

            document.body.appendChild(renderer.domElement);



            // Orbit controls adjusted to feel like walking

            controls = new THREE.OrbitControls(camera, renderer.domElement);

            controls.target.set(0, 10, 0);

            controls.enableDamping = true;

            controls.maxPolarAngle = Math.PI / 2; // Floor se niche nahi jayega camera



            const ambientLight = new THREE.AmbientLight(0x404040, 1);

            scene.add(ambientLight);



            const spotLight = new THREE.SpotLight(0x00f2ff, 1);

            spotLight.position.set(0, 40, 0);

            spotLight.castShadow = true;

            scene.add(spotLight);



            window.addEventListener('mousemove', onMouseMove);

            window.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);

            window.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);

        }



        function createEnvironment() {

            // Floor

            const floorGeo = new THREE.PlaneGeometry(100, 100);

            const floorMat = new THREE.MeshPhongMaterial({ color: 0x111111, side: THREE.DoubleSide });

            const floor = new THREE.Mesh(floorGeo, floorMat);

            floor.rotation.x = Math.PI / 2;

            floor.receiveShadow = true;

            scene.add(floor);



            // Table

            const tableGroup = new THREE.Group();

            const topGeo = new THREE.BoxGeometry(20, 1, 15);

            const tableMat = new THREE.MeshPhongMaterial({ color: 0x333333 });

            const tableTop = new THREE.Mesh(topGeo, tableMat);

            tableTop.position.y = 8;

            tableTop.receiveShadow = true;

            tableGroup.add(tableTop);



            // Table Legs

            const legGeo = new THREE.BoxGeometry(0.5, 8, 0.5);

            for(let x of [-9, 9]) {

                for(let z of [-6, 6]) {

                    const leg = new THREE.Mesh(legGeo, tableMat);

                    leg.position.set(x, 4, z);

                    tableGroup.add(leg);

                }

            }

            scene.add(tableGroup);



            // Lab Walls (Grid look)

            const grid = new THREE.GridHelper(100, 20, 0x00f2ff, 0x222222);

            scene.add(grid);

        }



        function createMotor() {

            motorGroup = new THREE.Group();

            motorGroup.position.y = 13; // Position on top of table



            const ironMat = new THREE.MeshPhongMaterial({ color: 0x243447, shininess: 80 });

            const steelMat = new THREE.MeshPhongMaterial({ color: 0xccd1d1, shininess: 120 });

            const copperMat = new THREE.MeshPhongMaterial({ color: 0xb87333, shininess: 100 });

            const fanMat = new THREE.MeshPhongMaterial({ color: 0x333333, shininess: 50 });



            addPart(new THREE.CylinderGeometry(4, 4, 10, 32, 1, true), ironMat, { rotationZ: Math.PI/2, id: 'frame', name: 'STATOR_FRAME' });

            

            for (let i = 0; i < 24; i++) {

                const angle = (i / 24) * Math.PI * 2;

                addPart(new THREE.BoxGeometry(10, 0.8, 0.2), ironMat, {

                    posY: Math.cos(angle) * 4.1, posZ: Math.sin(angle) * 4.1, rotX: -angle, id: 'rib', name: 'COOLING_RIB'

                });

            }



            addPart(new THREE.TorusGeometry(3.2, 0.4, 16, 50), copperMat, { posX: 4, rotationY: Math.PI/2, id: 'coil_r', name: 'COPPER_WINDING_A' });

            addPart(new THREE.TorusGeometry(3.2, 0.4, 16, 50), copperMat, { posX: -4, rotationY: Math.PI/2, id: 'coil_l', name: 'COPPER_WINDING_B' });



            const rotor = addPart(new THREE.CylinderGeometry(2.8, 2.8, 8, 24), steelMat, { rotationZ: Math.PI/2, id: 'rotor', name: 'SQUIRREL_CAGE_ROTOR' });

            rotor.name = "rotor_cage";



            const shaft = addPart(new THREE.CylinderGeometry(0.6, 0.6, 20, 32), steelMat, { rotationZ: Math.PI/2, id: 'shaft', name: 'DRIVE_SHAFT' });

            shaft.name = "shaft";



            addPart(new THREE.TorusGeometry(1, 0.3, 16, 32), steelMat, { posX: 5.2, rotationY: Math.PI/2, id: 'brg_r', name: 'BALL_BEARING_FRONT' });

            addPart(new THREE.TorusGeometry(1, 0.3, 16, 32), steelMat, { posX: -5.2, rotationY: Math.PI/2, id: 'brg_l', name: 'BALL_BEARING_REAR' });



            addPart(new THREE.CylinderGeometry(4.2, 4.2, 1, 32), ironMat, { posX: 5, rotationZ: Math.PI/2, id: 'bell_r', name: 'END_SHIELD_A' });

            addPart(new THREE.CylinderGeometry(4.2, 4.2, 1, 32), ironMat, { posX: -5, rotationZ: Math.PI/2, id: 'bell_l', name: 'END_SHIELD_B' });



            for(let i=0; i<6; i++) {

                const f = addPart(new THREE.BoxGeometry(0.2, 6, 1), fanMat, { posX: -7.5, rotX: (i*Math.PI)/3, id: 'fan', name: 'INTERNAL_FAN_BLADE' });

                f.name = "fan_blade_" + i;

            }



            addPart(new THREE.CylinderGeometry(3.8, 4.3, 3, 32, 1, true), ironMat, { posX: -9, rotationZ: Math.PI/2, id: 'cover', name: 'FAN_PROTECTION_COVER' });

            addPart(new THREE.BoxGeometry(3.5, 2, 3.5), ironMat, { posY: 4.8, id: 'box', name: 'TERMINAL_BOX' });

            addPart(new THREE.TorusGeometry(0.6, 0.15, 16, 32), steelMat, { posY: 6, id: 'eye', name: 'EYE_BOLT' });

            addPart(new THREE.BoxGeometry(8, 0.6, 1.5), ironMat, { posY: -4.2, posZ: 3.5, id: 'base', name: 'MOUNTING_BASE' });



            scene.add(motorGroup);

        }



        function addPart(geo, mat, props) {

            const mesh = new THREE.Mesh(geo, mat);

            if (props.posX) mesh.position.x = props.posX;

            if (props.posY) mesh.position.y = props.posY;

            if (props.posZ) mesh.position.z = props.posZ;

            if (props.rotX) mesh.rotation.x = props.rotX;

            if (props.rotationY) mesh.rotation.y = props.rotationY;

            if (props.rotationZ) mesh.rotation.z = props.rotationZ;

            mesh.userData.partId = props.id;

            mesh.userData.partName = props.name;

            motorGroup.add(mesh);

            materialsMap.set(mesh, mat);

            originalPositions.set(mesh, mesh.position.clone());

            return mesh;

        }



        function onMouseMove(event) {

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;

            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            tooltip.style.left = (event.clientX + 20) + 'px';

            tooltip.style.top = (event.clientY + 20) + 'px';

        }

        function getValueColor(val, low, high) { return (val >= low && val <= high) ? '#22c55e' : (val > high * 1.1 ? '#ef4444' : '#f59e0b'); }

        function closeInfoPopup() { document.getElementById('info-popup').classList.remove('visible'); hoveredMesh = null; }

        function formatPartTitle(mesh) {

            const id = mesh.userData.partId || (mesh.name || '').toLowerCase();

            return partIdToTitle[id] || (mesh.userData.partName || mesh.name || 'Component').replace(/_/g, ' ');

        }



        function toggleExplode() {

            isExploded = !isExploded;

            document.getElementById('explodeBtn').classList.toggle('active-btn');

        }



        function toggleView() {

            isBlueprint = !isBlueprint;

            motorGroup.traverse((child) => {

                if (child.isMesh) {

                    child.material = isBlueprint ? 

                        new THREE.MeshBasicMaterial({ color: 0x00f2ff, wireframe: true, transparent: true, opacity: 0.3 }) : 

                        materialsMap.get(child);

                }

            });

        }



        function handleMovement() {

            const speed = 0.5;

            const direction = new THREE.Vector3();

            camera.getWorldDirection(direction);

            direction.y = 0; // Prevent flying



            if (keys.w) camera.position.addScaledVector(direction, speed);

            if (keys.s) camera.position.addScaledVector(direction, -speed);

            

            const right = new THREE.Vector3().crossVectors(camera.up, direction).negate();

            if (keys.a) camera.position.addScaledVector(right, -speed);

            if (keys.d) camera.position.addScaledVector(right, speed);

            

            controls.target.copy(motorGroup.position);

        }



        function animate() {

            requestAnimationFrame(animate);

            handleMovement();



            const shaft = motorGroup.getObjectByName("shaft");

            const rotor = motorGroup.getObjectByName("rotor_cage");

            if (shaft) shaft.rotation.x += 0.15;

            if (rotor) rotor.rotation.x += 0.15;

            motorGroup.children.forEach(child => {

                if(child.name && child.name.includes("fan")) child.rotation.x += 0.15;

                

                // Explode logic

                const origPos = originalPositions.get(child);

                let targetPos = origPos.clone();

                if (isExploded) {

                    const id = child.userData.partId;

                    if (id === 'box') targetPos.y += 5;

                    if (id === 'eye') targetPos.y += 8;

                    if (id === 'base') targetPos.y -= 4;

                    if (['bell_r', 'brg_r', 'coil_r'].includes(id)) targetPos.x += 10;

                    if (['bell_l', 'brg_l', 'coil_l'].includes(id)) targetPos.x -= 10;

                    if (['fan', 'cover'].includes(id)) targetPos.x -= 15;

                }

                child.position.lerp(targetPos, 0.1);

            });



            raycaster.setFromCamera(mouse, camera);

            const meshes = []; motorGroup.traverse(function(c){ if(c.isMesh) meshes.push(c); });

            const intersects = raycaster.intersectObjects(meshes, true);

            const hit = intersects.length > 0 ? intersects[0] : null;

            if (hit && hit.object.userData.partId) {

                const mesh = hit.object;

                const popup = document.getElementById('info-popup');

                if (hoveredMesh !== mesh) {

                    if (hoveredMesh) {

                        hoveredMesh.material = isBlueprint ? new THREE.MeshBasicMaterial({ color: 0x00f2ff, wireframe: true, transparent: true, opacity: 0.3 }) : materialsMap.get(hoveredMesh);

                    }

                    hoveredMesh = mesh;

                    if (!isBlueprint) {

                        const mat = materialsMap.get(mesh);

                        if (mat && mat.emissive !== undefined) { mesh.material = mat.clone(); mesh.material.emissive = new THREE.Color(0x00f2ff); mesh.material.emissiveIntensity = 0.35; }

                    }

                    document.getElementById('popup-title').textContent = formatPartTitle(mesh);

                    popup.classList.add('visible');

                }

                const f = motorDisplayData.frequency, t = motorDisplayData.tempAvg, c = motorDisplayData.currentAvg, v = motorDisplayData.vibration;

                const freqEl = document.getElementById('popup-freq'); freqEl.textContent = f != null ? f.toFixed(1) + ' Hz' : '--'; freqEl.style.color = f != null ? getValueColor(f, 49.5, 50.5) : '#94a3b8';

                const tempEl = document.getElementById('popup-temp'); tempEl.textContent = t != null ? t.toFixed(1) + ' Â°C' : '--'; tempEl.style.color = t != null ? getValueColor(t, 40, 75) : '#94a3b8';

                const curEl = document.getElementById('popup-current'); curEl.textContent = c != null ? c.toFixed(1) + ' A' : '--'; curEl.style.color = c != null ? getValueColor(c, 60, 90) : '#94a3b8';

                const vibEl = document.getElementById('popup-vib'); vibEl.textContent = v != null ? v.toFixed(2) + ' mm/s' : '--'; vibEl.style.color = v != null ? getValueColor(v, 1, 3.5) : '#94a3b8';

                popup.style.left = ((mouse.x + 1) * 0.5 * window.innerWidth + 15) + 'px';

                popup.style.top = ((1 - mouse.y) * 0.5 * window.innerHeight + 15) + 'px';

                if (isExploded) { tooltip.style.display = 'block'; tooltip.innerText = hit.object.userData.partName; }

            } else {

                if (hoveredMesh) hoveredMesh.material = isBlueprint ? new THREE.MeshBasicMaterial({ color: 0x00f2ff, wireframe: true, transparent: true, opacity: 0.3 }) : materialsMap.get(hoveredMesh);

                hoveredMesh = null;

                document.getElementById('info-popup').classList.remove('visible');

                tooltip.style.display = isExploded && hit ? 'block' : 'none';

            }



            controls.update();

            renderer.render(scene, camera);

        }



        window.addEventListener('resize', () => {

            camera.aspect = window.innerWidth / window.innerHeight;

            camera.updateProjectionMatrix();

            renderer.setSize(window.innerWidth, window.innerHeight);

        });

    </script>

</body>

</html>

